<!DOCTYPE html>
<html lang="en">
	<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]--><!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]--><!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]--><!--[if (gte IE 9)|!(IE)]><!--><!--<![endif]--><head>
	<!-- Mobile Specific Metas-->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<!-- CSS -->
  	<link href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">
	<!--[if lt IE 9]>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Favicons -->
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">

  <!-- Wocum -->
	<meta charset="utf-8">
	<meta name="description" content="google drive powered CMS">
	<meta name="author" content="wocum.com">
	<title>wocum - google drive powered CMS</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery-ui-map/3.0-rc1/jquery.ui.map.js"></script>
	<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.0-rc2/js/bootstrap.min.js"></script>
	<script type="text/javascript" async="" src="http://www.google-analytics.com/ga.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.0.0/handlebars.min.js"></script>
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "ur-e09534f9-2a6e-a472-c066-e5e3d3364c07", doNotHash: true, doNotCopy: false, hashAddressBar: false});</script>
</head>
<body>
<div class="container">
  <div id="wocum"></div>
</div>
<script type="text/javascript">
function GetURLParameter(sParam) {
var sPageURL = window.location.search.substring(1);
var sURLVariables = sPageURL.split('&');
for (var i = 0; i < sURLVariables.length; i++)
{
var sParameterName = sURLVariables[i].split('=');
if (sParameterName[0] == sParam)
{
return sParameterName[1];
}
}
}
var gskey = GetURLParameter('key') || '0AkYWdwxH6K5XdFRILW9XRzRicjhZZU9icXlNckFtdUE';
var slug = GetURLParameter('id') || 'home'

function pageHandler (response) {
try 
{
wocumJSON = response.table.rows[0].c[0].v;
wocumTemplate = response.table.rows[0].c[1].v;
var template = Handlebars.compile(wocumTemplate);
var context = jQuery.parseJSON(wocumJSON);
var handlebarsHTML    = template(context);
document.getElementById("wocum").innerHTML = handlebarsHTML;
getFilesAndRelations ();
}
catch (err)
{
$.getScript('http://spreadsheets.google.com/tq?key='+gskey+'&range=wocum!A1:C&tq=select%20B,C%20where%20A%20%3D%20%22non-existing%22&tqx=responseHandler:nonExistingPageHandler');
}
}

function nonExistingPageHandler (response) {
try 
{
wocumJSON = '\{\"id\":\"'+slug+'\",\"name\":\"'+slug+'\"\}';
wocumTemplate = response.table.rows[0].c[1].v;
var template = Handlebars.compile(wocumTemplate);
var context = jQuery.parseJSON(wocumJSON);
var handlebarsHTML    = template(context);
document.getElementById("wocum").innerHTML = handlebarsHTML;
getFilesAndRelations ();
}
catch (err)
{
document.getElementById("wocum").innerHTML = 'Something went wrong. Hopefully you are not using this software to manage a nuclear reactor';
}
}

function getFilesAndRelations () {
$.getScript('http://spreadsheets.google.com/tq?key='+gskey+'&range=src_files!C1:D&tq=select%20D%20where%20C%20contains%20%22'+slug+'%22&tqx=responseHandler:filesHandler');
$.getScript('http://spreadsheets.google.com/tq?key='+gskey+'&range=wocum!A1:D&tq=select%20B%20where%20B%20contains%20%22'+slug+'%22&tqx=responseHandler:incomingRelationsHandler');
}

function filesHandler (response) {
var files = $.map(response.table.rows, function(item, index) {
return item.c[0].v;
});
if (typeof files !== 'undefined' && files.length > 0) {
files[0] = files[0].replace("item","active item");
document.getElementById("files-list").innerHTML= files.join('');
var showMedia = document.getElementById("wocum-media").style.display = 'inline';
}
}

function incomingRelationsHandler (response) {
var incomingRelations = $.map(response.table.rows, function(item, index) {
return item.c[0].v;
});
incomingRelations = '{"relations":['+incomingRelations+']}';  
if (typeof incomingRelations !== 'undefined' && incomingRelations.length > 0) {
var template = Handlebars.compile("{{#each relations}}<li id='{{id}}' class='{{type}}-wocum-card'><div><h4>{{#if type_image}}<img src='{{type_image}}' alt='type image' class='thumbnail'>{{/if}}<strong>{{type}}: <a href='{{url}}'>{{name}}</a></strong></h4></div>{{#if image}}<img src='{{image}}' alt='image' class='thumbnail'>{{/if}}<p class='excerpt'>{{excerpt}}</p><p class='fields'>{{{fields}}}</p></div>{{/each}}");
var context = jQuery.parseJSON(incomingRelations);
var handlebarsHTML    = template(context);
document.getElementById("relations-list").innerHTML=handlebarsHTML;
var showRelations = document.getElementById("wocum-relations").style.display = 'inline';
(function($) {

  $('.filterinput').keyup(function() {
    var a = $(this).val();
    if (a.length > 2) {
      // this finds all links in the list that contain the input, and hide the ones not containing the input while showing the ones that do
      var containing = $('#relations-list li').filter(function () {
        var regex = new RegExp('\\b' + a, 'i');
        return regex.test($('a', this).text());
      }).slideDown();
      $('#relations-list li').not(containing).slideUp();
    } else {
      $('#relations-list li').slideDown();
    }
  return false;
})
}(jQuery));
}
}
</script>
<script type="text/javascript">
(function () {
$.getScript('http://spreadsheets.google.com/tq?key='+gskey+'&range=wocum!A1:C&tq=select%20B,C%20where%20A%20%3D%20%22'+slug+'%22&tqx=responseHandler:pageHandler');
})()
</script>
</body></html>
