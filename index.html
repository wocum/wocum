<!DOCTYPE html>
  <html>
	<head>
		<meta charset="utf-8">
		<title>wocum - google docs powered CMS</title>
    		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
		<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
		<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-ui-map/3.0-rc1/jquery.ui.map.js"></script>
		<script type="text/javascript" async="" src="http://www.google-analytics.com/ga.js"></script>
		<script src="http://listjs.com/js/list.js"></script>


	</head>
	<body>
	  <div class="container-fluid" id="content">
				<div class="row-fluid" id="wocum-content">loading.....</div>

	  </div>

		<script>

		  function GetURLParameter(sParam) {
			var sPageURL = window.location.search.substring(1);
			var sURLVariables = sPageURL.split('&');
			for (var i = 0; i < sURLVariables.length; i++)
			{
				var sParameterName = sURLVariables[i].split('=');
				if (sParameterName[0] == sParam)
				{
					return sParameterName[1];
				}
			}
		}

		var gskey = GetURLParameter('key') || '0AlbPF4T7NQvfdDU5cXItS1EwMXJMSE1MRkZTajk4NGc';
		var slug = GetURLParameter('id') || 'default';

		function pageHandler (response) {
			wocumHTML = response.table.rows[0].c[0].v;
			document.getElementById("wocum-content").innerHTML = wocumHTML;
			$.getScript('https://spreadsheets.google.com/tq?key='+gskey+'&range=src_files!A1:B&tq=select%20A%20where%20B%20contains%20%22'+slug+'%22&tqx=responseHandler:filesHandler');
        		$.getScript('https://spreadsheets.google.com/tq?key='+gskey+'&range=wocum!A1:F&tq=select%20F%20where%20(C%20contains%20%22'+slug+'%22)%20or%20(D%20contains%20%22'+slug+'%22)&tqx=responseHandler:relationsHandler');
			}


    	function miniobjectHandler (response) {
			wocumHTML = response.table.rows[0].c[0].v;
			document.getElementById("wocum-content").innerHTML=wocumHTML;
        	linkify();
		}

		function linkify () {
        var wikiContents = document.getElementById('content');
    		wikiContents.innerHTML = wikiContents.innerHTML.wiki2html();
	    }
        function relationsHandler (response) {
			var relations = $.map(response.table.rows, function(item, index) {
				return item.c[0].v;
			});
            if (typeof relations !== 'undefined' && relations.length > 0) {
            document.getElementById("relations-list").innerHTML=relations.join(' ');
            var showRelations = document.getElementById("relations").style.display = 'inline';
            }
            linkify();
    		var options = {
    	    	valueNames: [ 'name', 'fields', 'description', 'category' ]
        	};
      		var relationsList = new List('relations', options);
		}

	function filesHandler (response) {
			var files = $.map(response.table.rows, function(item, index) {
				return item.c[0].v;
			});
            if (typeof files !== 'undefined' && files.length > 0) {
            files[0] = files[0].replace("item","active item");
	    document.getElementById("files-list").innerHTML= files.join('');
            var showMedia = document.getElementById("media").style.display = 'inline';
            }
		}

        // the regex beast...
        function wiki2html(s) {

            s = this;

            // lists need to be done using a function to allow for recusive calls
            function list(str) {
                return str.replace(/(?:(?:(?:^|\n)[\*#].*)+)/g, function (m) {  // (?=[\*#])
                    var type = m.match(/(^|\n)#/) ? 'OL' : 'UL';
                    // strip first layer of list
                    m = m.replace(/(^|\n)[\*#][ ]{0,1}/g, "$1");
                    m = list(m);
                    return '<' + type + '><li>' + m.replace(/^\n/, '').split(/\n/).join('</li><li>') + '</li></' + type + '>';
                });
            }

            return list(s
                .replace(/\[(.*?)\]/g, function (m, l) { // internal link or image
                    var p = l.split(/\|/);
                    var link = p.shift();
        		  	var linkId = link.replace(/ /g,"-");
        		  	var linkIdDecoded = encodeURIComponent(linkId);
                        return '<a href="?key='+gskey+'&id=' + linkIdDecoded + '">' + (p.length ? p.join('|') : link) + '</a>';
                })
				);

			}

		</script>


        <script>

            (function () {
                var template = GetURLParameter('template') || 'page';
                String.prototype.wiki2html = wiki2html;
                if ( template == 'miniobject' ) {
                    $.getScript('https://spreadsheets.google.com/tq?key='+gskey+'&range=wocum!A1:F&tq=select%20F%20where%20A%20%3D%20%22'+slug+'%22&tqx=responseHandler:miniobjectaHandler');        
                }

                else if ( template == 'page' ) {
                    $.getScript('https://spreadsheets.google.com/tq?key='+gskey+'&range=wocum!A1:B&tq=select%20B%20where%20A%20%3D%20%22'+slug+'%22&tqx=responseHandler:pageHandler');        
                }

                else {
                 document.write('no template defined');
                }
            })();
        </script>

</body>
</html>
